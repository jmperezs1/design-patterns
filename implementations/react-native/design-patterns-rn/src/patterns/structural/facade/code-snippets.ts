import type { CodeSnippet } from '../../../registry/types';

export const facadeCodeSnippets: CodeSnippet[] = [
  { title: 'facade.ts', language: 'ts', code: `import { AuditLogger } from './subsystems/audit-subsystem';\nimport { CalendarAPI } from './subsystems/calendar-subsystem';\nimport { CRMService } from './subsystems/crm-subsystem';\nimport { NotificationService } from './subsystems/notification-subsystem';\nimport { PaymentGateway } from './subsystems/payment-subsystem';\nimport type { Customer, Payment, Slot } from './types/types';\n\nexport class AppointmentFacade {\n  private calendar: CalendarAPI;\n  private payments: PaymentGateway;\n  private crm: CRMService;\n  private notify: NotificationService;\n  private log = new AuditLogger();\n\n  constructor(calendar?: CalendarAPI, payments?: PaymentGateway, crm?: CRMService, notify?: NotificationService, log? : AuditLogger) {\n    this.calendar = calendar ?? new CalendarAPI();\n    this.payments = payments ?? new PaymentGateway();\n    this.crm = crm ?? new CRMService();\n    this.notify = notify ?? new NotificationService();\n    this.log = log ?? new AuditLogger();\n  }\n\n  async book(opts: { customer: Customer; slot: Slot; payment: Payment; }): Promise<{ ok: true; steps: string[] } | { ok: false; steps: string[]; error: string }> {\n    const steps: string[] = [];\n    let reservationId: string | null = null;\n    let txId: string | null = null;\n    try {\n      const c = await this.crm.upsertCustomer(opts.customer);\n      steps.push(this.log.log(\`CRM: upserted customer ${'${'}c.customerId} (${ '${'}c.email})\`));\n      const res = await this.calendar.reserve(opts.slot);\n      reservationId = res.reservationId;\n      steps.push(this.log.log(\`Calendar: reserved slot ${'${'}reservationId}\`));\n      const pay = await this.payments.authorize(opts.payment);\n      txId = pay.txId;\n      steps.push(this.log.log(\`Payments: authorized ${'${'}pay.txId} ${'${'}pay.amount} ${'${'}pay.currency}\`));\n      const act = await this.crm.createActivity({ customerId: c.customerId, slot: opts.slot, txId });\n      steps.push(this.log.log(\`CRM: created activity ${'${'}act.activityId}\`));\n      await this.notify.email(c.email, 'Appointment confirmed', \`See you at ${'${'}opts.slot.start}\`);\n      steps.push(this.log.log(\`Notify: email sent to ${'${'}c.email}\`));\n      if (c.phone) {\n        await this.notify.sms(c.phone, 'Your appointment is confirmed.');\n        steps.push(this.log.log(\`Notify: SMS sent to ${'${'}c.phone}\`));\n      }\n      steps.push('Booking complete');\n      return { ok: true, steps };\n    } catch (e) {\n      const msg = (e as Error).message || 'Unknown error';\n      steps.push(\`Failed: ${'${'}msg}\`);\n      if (txId) {\n        await this.payments.void(txId);\n        steps.push(this.log.log(\`Rollback: voided payment ${'${'}txId}\`));\n      }\n      if (reservationId) {\n        await this.calendar.cancel(reservationId);\n        steps.push(this.log.log(\`Rollback: cancelled reservation ${'${'}reservationId}\`));\n      }\n      return { ok: false, steps, error: msg };\n    }\n  }\n}` },
];
